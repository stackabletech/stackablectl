releaseName: opensearch
name: opensearch
repo:
  name: opensearch
  url: https://opensearch-project.github.io/helm-charts
version: 2.13.3
options:
  config:
    opensearch.yml: |
      plugins:
        security:
          # Use default security settings
          allow_default_init_securityindex: true
          # Allow communication between the nodes which use the
          # certificates generated by the secret-operator
          nodes_dn:
            - CN=generated certificate for pod
          # Use the certificate generated by the secret-operator
          ssl:
            http:
              # Enable TLS on the REST layer
              enabled: true
              pemcert_filepath: certs/tls.crt
              pemkey_filepath: certs/tls.key
              pemtrustedcas_filepath: certs/ca.crt
            transport:
              pemcert_filepath: certs/tls.crt
              pemkey_filepath: certs/tls.key
              pemtrustedcas_filepath: certs/ca.crt
              # Disable the verification of hostnames because
              # internal IPs are used which are not included in
              # the certificates generated by the secret-operator.
              enforce_hostname_verification: false
  securityConfig:
    path: /usr/share/opensearch/config/opensearch-security
    internalUsersSecret: opensearch-internal-users
  sysctlInit:
    enabled: {{ setSysctlMaxMapCount }}
  extraEnvs:
    # Disable the creation of demo certificates
    - name: DISABLE_INSTALL_DEMO_CONFIG
      value: "true"
  extraVolumeMounts:
    # Mount the certificate generated by the secret-operator
    - name: tls
      mountPath: /usr/share/opensearch/config/certs
  extraVolumes:
    # Request a TLS certificate from the secret-operator
    - name: tls
      ephemeral:
        volumeClaimTemplate:
          metadata:
            annotations:
              secrets.stackable.tech/class: tls
              # Add the service opensearch-cluster-master to the
              # distinguished names because this service is used
              # by Vector.
              secrets.stackable.tech/scope: |-
                service=opensearch-cluster-master
          spec:
            storageClassName: secrets.stackable.tech
            accessModes:
              - ReadWriteOnce
            resources:
              requests:
                storage: 1
  extraObjects:
    - apiVersion: v1
      kind: Secret
      metadata:
        name: opensearch-internal-users
      stringData:
        internal_users.yml: |
          ---
          # This is the internal user database.
          # The hash value is a bcrypt hash.

          _meta:
            type: "internalusers"
            config_version: 2

          admin:
            hash: "{{ bcrypt(password=openSearchAdminPassword) }}"
            reserved: true
            backend_roles:
              - "admin"
            description: "OpenSearch admin user"

          kibanaserver:
            hash: "{{ bcrypt(password=openSearchDashboardPassword) }}"
            reserved: true
            description: "OpenSearch Dashboard user"
    - apiVersion: v1
      kind: Secret
      metadata:
        name: opensearch-user
      stringData:
        username: admin
        password: {{ openSearchAdminPassword }}
    - apiVersion: v1
      kind: Secret
      metadata:
        name: opensearch-dashboard-user
      stringData:
        username: kibanaserver
        password: {{ openSearchDashboardPassword }}
        cookie: {{ random_password() }}
